{% extends "base.html" %}

{% block content %}

<!-- –ú–ê–ö–†–û–° –ö–ê–†–¢–û–ß–ö–ò (–î–æ–±–∞–≤–∏–ª–∏ onclick –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è) -->
{% macro booking_card(b) %}
<div class="kanban-card" data-id="{{ b.id }}" data-priority="{{ b.priority }}" onclick="openBookingModal({{ b.id }})">
    <div class="d-flex justify-content-between align-items-start mb-2">
        <span class="badge bg-light text-secondary border fw-normal">#{{ b.id }}</span>
        <!-- –ò–∫–æ–Ω–∫–∞ –≤—ã—Å–æ–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ -->
        <i class="fa fa-bolt text-danger priority-icon {% if b.priority != 'high' %}d-none{% endif %}" title="–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç"></i>
    </div>
    
    <h6 class="card-client-name">{{ b.client_name }}</h6>
    <p><i class="fa fa-map-pin me-1"></i> <span class="card-tour-type">{{ b.tour_type }}</span></p>
    
    <!-- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π -->
    <div class="mb-2">
        {% if b.manager %}
            <span class="badge bg-info bg-opacity-10 text-info border border-info rounded-pill small">
                <i class="fa fa-user me-1"></i>{{ b.manager.username }}
            </span>
        {% else %}
            <span class="badge bg-secondary bg-opacity-10 text-secondary rounded-pill small">–ù–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞</span>
        {% endif %}
    </div>

    <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
        <span class="price-tag">{{ "{:,.0f}".format(b.price) }} ‚ÇΩ</span>
        <span class="date-tag">{{ b.tour_date.strftime('%d.%m') }}</span>
    </div>
</div>
{% endmacro %}

<div class="row g-4">
    <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
    <div class="col-lg-3 col-md-12">
        <!-- –§–∏–Ω–∞–Ω—Å—ã -->
        <div class="card">
            <div class="card-header"><span><i class="fa fa-chart-pie me-2 text-secondary"></i>KPI</span></div>
            <div class="card-body text-center">
                <h2 class="text-success fw-bold mb-0">+{{ "{:,.0f}".format(stats.margin) }} ‚ÇΩ</h2>
                <small class="text-muted">–ü—Ä–∏–±—ã–ª—å –∑–∞ –ø–µ—Ä–∏–æ–¥</small>
            </div>
        </div>
        
        <!-- –ß–∞—Ç -->
        <div class="card h-auto">
            <div class="card-header">
                <span><i class="fa fa-comments me-2 text-secondary"></i>–ß–∞—Ç</span>
            </div>
            <div class="card-body p-3">
                <div id="chatBox" class="chat-container mb-3" style="height: 300px;">
                    {% for msg in chat_history %}
                        <div class="msg-bubble {% if msg.sender == '–í—ã' %}msg-out{% else %}msg-in{% endif %}">
                            <strong>{{ msg.sender }}:</strong><div class="small">{{ msg.text }}</div>
                        </div>
                    {% endfor %}
                </div>
                <div class="input-group">
                    <input type="text" id="chatInput" class="form-control" placeholder="...">
                    <button class="btn btn-brand" onclick="sendMsg()"><i class="fa fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê (KANBAN) -->
    <div class="col-lg-9 col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold mb-1">–ó–∞–¥–∞—á–∏</h4>
            <form action="/create_quick_booking" method="POST">
                <button type="submit" class="btn btn-brand shadow-sm"><i class="fa fa-plus me-2"></i>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
            </form>
        </div>

        <div class="row flex-nowrap overflow-auto pb-4 px-2">
            <div class="col-md-3" style="min-width: 260px;">
                <div class="kanban-title text-warning">‚óè –í—Ö–æ–¥—è—â–∏–µ ({{ bookings_new|length }})</div>
                <div id="new" class="kanban-col" data-status="new">
                    {% for b in bookings_new %}{{ booking_card(b) }}{% endfor %}
                </div>
            </div>
            <div class="col-md-3" style="min-width: 260px;">
                <div class="kanban-title text-primary">‚óè –í —Ä–∞–±–æ—Ç–µ</div>
                <div id="confirmed" class="kanban-col" data-status="confirmed">
                    {% for b in bookings_conf %}{{ booking_card(b) }}{% endfor %}
                </div>
            </div>
            <div class="col-md-3" style="min-width: 260px;">
                <div class="kanban-title text-success">‚óè –û–ø–ª–∞—á–µ–Ω–æ</div>
                <div id="paid" class="kanban-col" data-status="paid">
                    {% for b in bookings_paid %}{{ booking_card(b) }}{% endfor %}
                </div>
            </div>
            <div class="col-md-3" style="min-width: 260px;">
                <div class="kanban-title text-secondary">‚óè –ê—Ä—Ö–∏–≤</div>
                <div id="completed" class="kanban-col" data-status="completed">
                    {% for b in bookings_done %}{{ booking_card(b) }}{% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø (POPUP) -->
<!-- ========================================== -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">–ó–∞—è–≤–∫–∞ #<span id="modalId"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –§–æ—Ä–º–∞ -->
                    <div class="col-md-7 border-end">
                        <form id="editForm">
                            <input type="hidden" id="editId">
                            
                            <div class="mb-3">
                                <label class="small text-muted">–ö–ª–∏–µ–Ω—Ç</label>
                                <input type="text" id="editClient" class="form-control fw-bold">
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="small text-muted">–¢–∏–ø —Ç—É—Ä–∞</label>
                                    <input type="text" id="editTour" class="form-control">
                                </div>
                                <div class="col-6">
                                    <label class="small text-muted">–î–∞—Ç–∞</label>
                                    <input type="date" id="editDate" class="form-control">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="small text-muted">–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label>
                                    <input type="number" id="editPrice" class="form-control text-primary fw-bold">
                                </div>
                                <div class="col-6">
                                    <label class="small text-muted">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                                    <select id="editPriority" class="form-select">
                                        <option value="medium">–û–±—ã—á–Ω—ã–π</option>
                                        <option value="high">üî• –í—ã—Å–æ–∫–∏–π</option>
                                        <option value="low">–ù–∏–∑–∫–∏–π</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="small text-muted">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</label>
                                <select id="editManager" class="form-select">
                                    <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                                    {% for m in managers %}
                                        <option value="{{ m.id }}">{{ m.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <button type="button" onclick="saveBooking()" class="btn btn-brand w-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                        </form>
                    </div>

                    <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
                    <div class="col-md-5">
                        <h6 class="text-muted small text-uppercase fw-bold mb-3">–ó–∞–º–µ—Ç–∫–∏ –∏ –ò—Å—Ç–æ—Ä–∏—è</h6>
                        <div id="notesList" class="bg-light p-2 rounded mb-3" style="height: 300px; overflow-y: auto;">
                            <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
                        </div>
                        <div class="input-group">
                            <input type="text" id="newNoteInput" class="form-control form-control-sm" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–º–µ—Ç–∫—É...">
                            <button class="btn btn-secondary btn-sm" onclick="addNote()"><i class="fa fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ Bootstrap ---
    var myModal = new bootstrap.Modal(document.getElementById('bookingModal'));

    // 1. –û–¢–ö–†–´–¢–ò–ï –û–ö–ù–ê
    function openBookingModal(id) {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
        fetch(`/api/booking/${id}/details`)
            .then(res => res.json())
            .then(data => {
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
                document.getElementById('modalId').innerText = data.id;
                document.getElementById('editId').value = data.id;
                document.getElementById('editClient').value = data.client;
                document.getElementById('editTour').value = data.tour;
                document.getElementById('editPrice').value = data.price;
                document.getElementById('editDate').value = data.date;
                document.getElementById('editPriority').value = data.priority;
                document.getElementById('editManager').value = data.manager_id || "";

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                renderNotes(data.notes);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ
                myModal.show();
            });
    }

    // 2. –û–¢–†–ò–°–û–í–ö–ê –ó–ê–ú–ï–¢–û–ö
    function renderNotes(notes) {
        const list = document.getElementById('notesList');
        list.innerHTML = '';
        if (notes.length === 0) {
            list.innerHTML = '<div class="text-center text-muted small mt-5">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div>';
            return;
        }
        notes.forEach(note => {
            list.innerHTML += `
                <div class="card p-2 mb-2 border-0 shadow-sm">
                    <div class="d-flex justify-content-between small text-muted">
                        <span>${note.author}</span>
                        <span>${note.date}</span>
                    </div>
                    <div class="small mt-1">${note.text}</div>
                </div>`;
        });
        list.scrollTop = list.scrollHeight;
    }

    // 3. –°–û–•–†–ê–ù–ï–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô
    function saveBooking() {
        const data = {
            id: document.getElementById('editId').value,
            client: document.getElementById('editClient').value,
            tour: document.getElementById('editTour').value,
            price: document.getElementById('editPrice').value,
            date: document.getElementById('editDate').value,
            priority: document.getElementById('editPriority').value,
            manager_id: document.getElementById('editManager').value
        };

        fetch('/api/booking/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(res => res.json()).then(resp => {
            if(resp.success) {
                location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        });
    }

    // 4. –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ú–ï–¢–ö–ò
    function addNote() {
        const text = document.getElementById('newNoteInput').value;
        const id = document.getElementById('editId').value;
        if (!text) return;

        fetch('/api/booking/add_note', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({booking_id: id, text: text})
        })
        .then(res => res.json())
        .then(resp => {
            if(resp.success) {
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–º–µ—Ç–∫—É –≤ —Å–ø–∏—Å–æ–∫ –≤–∏–∑—É–∞–ª—å–Ω–æ
                const list = document.getElementById('notesList');
                // –£–±–∏—Ä–∞–µ–º –Ω–∞–¥–ø–∏—Å—å "–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫", –µ—Å–ª–∏ –±—ã–ª–∞
                if(list.innerText === "–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫") list.innerHTML = '';
                
                list.innerHTML += `
                    <div class="card p-2 mb-2 border-0 shadow-sm">
                        <div class="d-flex justify-content-between small text-muted">
                            <span>${resp.author}</span>
                            <span>${resp.date}</span>
                        </div>
                        <div class="small mt-1">${text}</div>
                    </div>`;
                document.getElementById('newNoteInput').value = '';
                list.scrollTop = list.scrollHeight;
            }
        });
    }

    // --- KANBAN DRAG & DROP ---
    const columns = document.querySelectorAll('.kanban-col');
    columns.forEach(col => {
        new Sortable(col, {
            group: 'kanban',
            animation: 200,
            ghostClass: 'opacity-50',
            onEnd: function (evt) {
                let bookingId = evt.item.getAttribute('data-id');
                let newStatus = evt.to.getAttribute('data-status');
                fetch('/api/booking/status', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: bookingId, status: newStatus})
                });
            }
        });
    });
    
    // --- CHAT LOGIC ---
    let chatBox = document.getElementById('chatBox');
    chatBox.scrollTop = chatBox.scrollHeight;
    function sendMsg() {
        let input = document.getElementById('chatInput');
        if(!input.value.trim()) return;
        fetch('/api/chat/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: input.value, channel: 'general'})
        }).then(() => location.reload()); 
    }
</script>
{% endblock %}